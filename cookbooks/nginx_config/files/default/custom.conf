# belongs in /etc/nginx/servers/examtime/custom.conf

# map any non .com domains to .com/[tld]
if ($tld_path != "false") {
  rewrite /(.*) http://$tld_path/$1 permanent;
}

# Redirect to www if non-www
if ($host = "examtime.com") {
  rewrite ^(.*)$ http://www.examtime.com$1 permanent;
}

# Maps all the top level folders to their respective folders on the brochure site
location ~ ^/(feed|blog-search|sitemap|mind-maps|flashcards|revision-timetable|study-resources|study-goals|study-planner|notes-software|quiz-maker|contact|pricing|practice-papers|exam-revision|online-study|jobs|study-groups|guide|student|teacher|about|news|blog|faqs|wp-content|wp-includes|xmlrpc.php)(/|$) { 

  resolver 8.8.8.8;
  rewrite ^([^.]*[^/])$ http://$host$1/ permanent;
  rewrite /(.*) /$1 break;
  proxy_pass http://$tld;
  server_name_in_redirect off;
  proxy_redirect http://$tld/*/ /*/;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host $host;

}

# map /brochure/sitemap.xml to /sitemap.xml on brochure
location ~ ^/brochure/sitemap.xml$ {
  resolver 8.8.8.8;
  proxy_pass http://$tld/sitemap.xml;
}

# because the brochure /sitemap.xml links to a load of other sitemaps (e.g. sitemap-misc.xml),
# we need to map /sitemap-*.xml to proxy to brochure site
location ~ ^/(sitemap-).*\.xml$ {
  resolver 8.8.8.8;
  proxy_pass http://$tld;
}


# proxy pass locale sitemaps to their respective servers
location /de/sitemap.xml    { resolver 8.8.8.8; proxy_pass http://infode.examtime.com/sitemap.xml;    }
location /es/sitemap.xml    { resolver 8.8.8.8; proxy_pass http://infoes.examtime.com/sitemap.xml;    }
location /pt/sitemap.xml    { resolver 8.8.8.8; proxy_pass http://infopt.examtime.com/sitemap.xml;    }
location /pt-BR/sitemap.xml { resolver 8.8.8.8; proxy_pass http://infopt-br.examtime.com/sitemap.xml; }

# proxy pass locale sitemap-*.xml files to their respective servers
location ~ ^/de/(sitemap-).*\.xml$    { resolver 8.8.8.8; proxy_pass http://infode.examtime.com;    }
location ~ ^/es/(sitemap-).*\.xml$    { resolver 8.8.8.8; proxy_pass http://infoes.examtime.com;    }
location ~ ^/pt/(sitemap-).*\.xml$    { resolver 8.8.8.8; proxy_pass http://infopt.examtime.com;    }
location ~ ^/pt-BR/(sitemap-).*\.xml$ { resolver 8.8.8.8; proxy_pass http://infopt-br.examtime.com; }


############################################################################################################
# OLD PROXY PASS STATEMENTS - BIZARRELY, THESE DON'T WORK AND RESULT IN GATEWAY ERRORS FOR THE SITEMAPS
#
## map /[locale]/sitemap.xml to /sitemap.xml on info[locale]
#location ~ ^/(de|es|pt|pt-BR)/sitemap.xml$ {
#  resolver 8.8.8.8;
#  proxy_pass http://info$1.examtime.com/sitemap.xml;
#}
#
## because the locale's /sitemap.xml links to a load of other sitemaps (e.g. sitemap-misc.xml),
## we need to map /sitemap-*.xml to proxy to relevant brochure site
#location ~ ^/(de|es|pt|pt-BR)/(sitemap-).*\.xml$ {
#  resolver 8.8.8.8;
#  proxy_pass http://info$1.examtime.com;
#}
#
############################################################################################################


# mapping for German (de) brochure
location ~ ^/de/(blog|feed|sitemap|about|guide|lehrer|schueler-studenten|news|abitur|faqs|karteikarten-online-erstellen|lerngruppen|lernhilfen|lernplan|lernquiz|lernziele-formulieren|mindmap-online-erstellen|notiz-app|online-lernen|prufungsvorbereitung|schueler-studenten|stundenplan-erstellen|teilen)(/|$) {
  resolver 8.8.8.8;
  rewrite ^([^.]*[^/])$ http://$host$1/ permanent;
  rewrite /de/(.*) /$1 break;
  proxy_pass http://infode.examtime.com;
  server_name_in_redirect off;
  proxy_redirect http://infode.examtime.com/*/ /*/;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host $host;
}


# mapping for Portuguese (pt) brochure
location ~ ^/pt/(blog|feed|sitemap|dicas|recursos|info|estudantes|professores|faqs|mapas-mentais|estudar-online|flashcards|quiz|exemplos-de-recursos-de-estudo|calendario-de-estudo|criar-objetivos-de-estudo|provas-modelo|notas|partilhar|provas-modelo|grupos)(/|$) {
  resolver 8.8.8.8;
  rewrite ^([^.]*[^/])$ http://$host$1/ permanent;
  rewrite /pt/(.*) /$1 break;
  proxy_pass http://infopt.examtime.com;
  server_name_in_redirect off;
  proxy_redirect http://infopt.examtime.com/*/ /*/;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host $host;
}


# mapping for Spanish (es) brochure
location ~ ^/es/(blog|feed|sitemap|estudiantes|guia|info|profesores|recursos|mapas-mentales|fichas|tests|calendario-de-estudio-online|recursos-de-estudio|metas-de-estudio|faqs|apuntes|examenes-de-prueba|online-estudiar|grupos|compartir|examtime-para-estudiantes)(/|$) {
  resolver 8.8.8.8;
  rewrite ^([^.]*[^/])$ http://$host$1/ permanent;
  rewrite /es/(.*) /$1 break;
  proxy_pass http://infoes.examtime.com;
  server_name_in_redirect off;
  proxy_redirect http://infoes.examtime.com/*/ /*/;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host $host;
}


# mapping for Brazilian (pt-BR) brochure
location ~ ^/pt-BR/(blog|feed|sitemap|faqs|estudante|guias|professor|sobre|mapas-mentais|enem|calendario-de-estudo|estude-para-o-vestibular|quiz|flashcards|estudar-para-concursos|estudar-online|memory-cards|notas|estudar-para-oab|grupos-de-estudos|estudar-para-as-provas|simulados-online|recursos-educacionais|examtime-para-todos|simulados-online|compartilhar|calendario|estude-idiomas-online|grupos|aplicativos-educacionais-gratis|comunidade-de-aprendizagem|crie-objetivos-de-estudo|historias-de-sucesso|organize-seu-tempo)(/|$) {
  resolver 8.8.8.8;
  rewrite ^([^.]*[^/])$ http://$host$1/ permanent;
  rewrite /pt-BR/(.*) /$1 break;
  proxy_pass http://infopt-br.examtime.com;
  server_name_in_redirect off;
  proxy_redirect http://infopt-br.examtime.com/*/ /*/;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Host $host;
}